<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="./axios.js"></script>
    <script src="./api.js"></script>
    <title>Document</title>
</head>
<style>

</style>
<body>
    <h2>Dashboard</h2>
    <button onclick="logout(event)">Logout</button>
    <button onclick="manageCompany(event)">Manage Company</button>
    <button onclick="manageQueues(event)">Manage Queues</button>
    <button onclick="deleteCompany(event)">Delete your Company</button>
    <br><br>
    <h2>Queues</h2>
</body>
<script>
    const company = JSON.parse(localStorage.getItem('company'))

    const token = company.token
    const companyId = company.company.id

    api.defaults.headers = {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`
    }

    const logout = (event) => {
        event.preventDefault()

        localStorage.clear('company')

        window.location.href = './companyLogin.html'
    }

    const manageCompany = (event) => {
        event.preventDefault()

        window.location.href = './manageCompany.html'
    }

    const manageQueues = (event) => {
        event.preventDefault()

        window.location.href = './manageQueues.html'
    }

    const handleUserFromQueue = async (event, queueId) => {
        event.preventDefault()

        const handleResponse = await api.post(`/queue/${queueId}/user`)
        
        const { userId } = handleResponse.data.handledPosition

        const userResponse = await api.get(`/user/${userId}`)

        const { name, phone } = userResponse.data

        alert(`Handled User:\nName: ${name}\nPhone: ${phone}`)
    }

    const deleteCompany = async (event) => {
        event.preventDefault()

        if (window.confirm('Are you sure?')) {
            await api.delete(`/company/${companyId}`)

            window.location.href = './companyLogin.html'
        }
    }

    api.get(`/company/${companyId}`).then(res => {
        const company = res.data
        const companyH1 = `<h1>${company.name}</h1><p>${company.email}</p>`
        document.body.insertAdjacentHTML('afterbegin', companyH1)
    })

    api.get('/queue').then(res => {
        const queues = res.data.reduce(
            (html, queue) => html + 
            `<li>
                id: ${queue.id}
                <br>
                ingress code: ${queue.ingressCode}
                <br>
                observation: ${queue.observation}
                <br>
                start time: ${queue.startTime}
                <br>
                end time: ${queue.endTime}
                <br>
                <button onclick="handleUserFromQueue(event, ${queue.id})">Handle user</button>
                <br><br>
            </li>`, ''
        )
        document.body.insertAdjacentHTML('beforeEnd', `<ul>${queues}</ul>`)
    })
</script>
</html>